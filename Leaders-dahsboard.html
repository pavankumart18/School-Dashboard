<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Regional Intelligence ‚Äî EU Portfolio Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;1,9..144,300;1,9..144,400&family=Bricolage+Grotesque:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --stone-50:#fafaf9;--stone-100:#f5f4f0;--stone-200:#e8e5df;--stone-300:#d4cfc6;
  --stone-400:#a89e90;--stone-500:#7a7060;--stone-600:#5a5248;--stone-700:#3d3730;
  --stone-800:#26211c;--stone-900:#141210;
  --ink:#1a1614;--ink-mid:#3d3730;--ink-soft:#7a7060;--ink-ghost:#b0a898;
  --border:#e0dbd2;--border-strong:#c8c2b8;
  --crimson:#c0392b;--crimson-dim:#fdf0ee;--crimson-mid:#e8a09a;
  --emerald:#1a6b50;--emerald-dim:#edf7f3;--emerald-mid:#6ec4a0;
  --amber:#b8680a;--amber-dim:#fdf5e6;--amber-mid:#e8b46e;
  --cobalt:#1a3a7a;--cobalt-dim:#eef2fb;--cobalt-mid:#7a9ee8;
  --paper:var(--stone-50);--surface:#ffffff;--raised:var(--stone-100);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Bricolage Grotesque',sans-serif;background:var(--stone-100);color:var(--ink);min-height:100vh;overflow-x:hidden;}
a{color:inherit;text-decoration:none;}

.header{background:var(--ink);padding:0 40px;display:flex;align-items:stretch;height:58px;position:sticky;top:0;z-index:200;gap:0;}
.header-brand{display:flex;align-items:center;gap:14px;padding-right:32px;border-right:1px solid rgba(255,255,255,0.1);}
.header-logo{width:30px;height:30px;background:linear-gradient(135deg,var(--amber-mid),var(--amber));border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;}
.header-name{font-family:'Fraunces',serif;font-size:16px;font-weight:500;color:#fff;letter-spacing:-0.01em;}
.header-name span{font-style:italic;font-weight:300;color:rgba(255,255,255,0.55);}
.header-nav{display:flex;align-items:stretch;gap:0;padding:0 20px;flex:1;}
.nav-tab{display:flex;align-items:center;padding:0 18px;font-size:12px;font-weight:500;color:rgba(255,255,255,0.45);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s;letter-spacing:0.01em;white-space:nowrap;}
.nav-tab:hover{color:rgba(255,255,255,0.75);}
.nav-tab.active{color:#fff;border-bottom-color:var(--amber-mid);}
.nav-badge{background:var(--crimson);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:8px;margin-left:6px;}
.header-right{display:flex;align-items:center;gap:10px;padding-left:20px;border-left:1px solid rgba(255,255,255,0.1);}
.hdr-chip{font-family:'Fira Code',monospace;font-size:10px;padding:4px 10px;border-radius:14px;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.hdr-chip.on{background:rgba(232,180,110,0.2);color:var(--amber-mid);border:1px solid rgba(232,180,110,0.3);}
.hdr-chip.off{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.1);}
.hdr-chip select{background:transparent;border:none;font-family:inherit;font-size:inherit;color:inherit;cursor:pointer;outline:none;}

.content{padding:28px 40px;}
.slabel{font-family:'Fira Code',monospace;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--ink-ghost);margin-bottom:14px;display:flex;align-items:center;gap:12px;}
.slabel::after{content:'';flex:1;height:1px;background:var(--border);}

/* Hero strip */
.region-hero{background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:20px;overflow:hidden;display:grid;grid-template-columns:repeat(5,1fr);}
.hero-cell{padding:22px 24px;border-right:1px solid var(--border);position:relative;transition:background 0.15s;cursor:default;}
.hero-cell:last-child{border-right:none;}
.hero-cell:hover{background:var(--raised);}
.hero-cell::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--border);}
.hero-cell.bad::before{background:var(--crimson);}
.hero-cell.warn::before{background:var(--amber);}
.hero-cell.good::before{background:var(--emerald);}
.hero-cell.info::before{background:var(--cobalt);}
.hc-label{font-family:'Fira Code',monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-ghost);margin-bottom:6px;}
.hc-value{font-family:'Fraunces',serif;font-size:36px;font-weight:400;letter-spacing:-0.03em;line-height:1;color:var(--ink);}
.hc-value.bad{color:var(--crimson);}.hc-value.warn{color:var(--amber);}.hc-value.good{color:var(--emerald);}
.hc-delta{display:inline-flex;align-items:center;gap:3px;font-family:'Fira Code',monospace;font-size:10px;font-weight:500;padding:2px 8px;border-radius:10px;margin-top:8px;}
.hc-delta.dn{background:var(--crimson-dim);color:var(--crimson);}
.hc-delta.up{background:var(--emerald-dim);color:var(--emerald);}
.hc-delta.fl{background:var(--stone-100);color:var(--ink-soft);}
.hc-delta.wn{background:var(--amber-dim);color:var(--amber);}
.hc-sub{font-size:10px;color:var(--ink-ghost);margin-top:5px;}
.hc-spark{margin-top:10px;}

/* Table */
.school-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:20px;}
.school-table-head{padding:16px 24px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--raised);}
.sth-title{font-size:13px;font-weight:600;color:var(--ink);}
.sth-sub{font-size:10px;color:var(--ink-ghost);font-family:'Fira Code',monospace;margin-top:2px;}
.sort-btns{display:flex;gap:6px;}
.sort-btn{font-family:'Fira Code',monospace;font-size:9px;padding:3px 10px;border-radius:12px;cursor:pointer;border:1px solid var(--border);color:var(--ink-soft);background:var(--surface);transition:all 0.15s;letter-spacing:0.04em;}
.sort-btn:hover{border-color:var(--border-strong);color:var(--ink);}
.sort-btn.on{background:var(--ink);color:#fff;border-color:var(--ink);}
.school-table{width:100%;border-collapse:collapse;}
.school-table th{font-family:'Fira Code',monospace;font-size:8.5px;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-ghost);font-weight:400;padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;background:var(--raised);}
.school-table th.num{text-align:right;}
.school-table td{padding:12px 16px;font-size:12px;color:var(--ink-mid);border-bottom:1px solid var(--border);vertical-align:middle;}
.school-table tr:last-child td{border-bottom:none;}
.school-table tr:hover td{background:var(--raised);}
.school-table td.num{text-align:right;}
.school-name-cell{display:flex;align-items:center;gap:10px;}
.school-initial{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;font-family:'Fraunces',serif;}
.school-nm{font-size:12px;font-weight:600;color:var(--ink);}
.school-loc{font-size:10px;color:var(--ink-ghost);font-family:'Fira Code',monospace;}
.ibar-wrap{display:flex;align-items:center;gap:8px;}
.ibar-track{flex:1;height:6px;background:var(--stone-200);border-radius:3px;overflow:hidden;min-width:60px;}
.ibar-fill{height:100%;border-radius:3px;}
.ibar-val{font-family:'Fira Code',monospace;font-size:10px;min-width:38px;text-align:right;}
.sdot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:5px;}
.sdot.red{background:var(--crimson);}.sdot.amber{background:var(--amber);}.sdot.green{background:var(--emerald);}
.rag{display:inline-flex;align-items:center;font-family:'Fira Code',monospace;font-size:9px;font-weight:500;padding:2px 8px;border-radius:10px;letter-spacing:0.04em;}
.rag.r{background:var(--crimson-dim);color:var(--crimson);}
.rag.a{background:var(--amber-dim);color:var(--amber);}
.rag.g{background:var(--emerald-dim);color:var(--emerald);}
.total-row td{background:var(--stone-100);font-weight:600;border-top:2px solid var(--border-strong)!important;}
.drill-link{font-family:'Fira Code',monospace;font-size:9px;color:var(--cobalt);text-decoration:underline;margin-left:6px;cursor:pointer;}

/* Grids */
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;}
.grid-2-1{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:20px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.card-head{padding:15px 20px 13px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;}
.card-title{font-size:13px;font-weight:600;color:var(--ink);}
.card-sub{font-size:10px;color:var(--ink-ghost);font-family:'Fira Code',monospace;margin-top:2px;}
.card-body{padding:20px;}
.badge{font-family:'Fira Code',monospace;font-size:9px;padding:3px 8px;border-radius:10px;}
.badge-r{background:var(--crimson-dim);color:var(--crimson);}
.badge-a{background:var(--amber-dim);color:var(--amber);}
.badge-g{background:var(--emerald-dim);color:var(--emerald);}
.badge-b{background:var(--cobalt-dim);color:var(--cobalt);}

/* Watchlist */
.watchlist-row{display:flex;align-items:flex-start;gap:12px;padding:13px 20px;border-bottom:1px solid var(--border);transition:background 0.12s;cursor:default;}
.watchlist-row:last-child{border-bottom:none;}
.watchlist-row:hover{background:var(--raised);}
.watch-sev{width:3px;align-self:stretch;border-radius:2px;flex-shrink:0;}
.watch-sev.critical{background:var(--crimson);}.watch-sev.warn{background:var(--amber);}
.watch-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.wi-red{background:var(--crimson-dim);}.wi-amber{background:var(--amber-dim);}
.watch-body{flex:1;}
.watch-title{font-size:12px;font-weight:600;color:var(--ink);margin-bottom:2px;}
.watch-desc{font-size:11px;color:var(--ink-soft);line-height:1.5;}
.watch-metric{font-family:'Fira Code',monospace;font-size:9px;color:var(--ink-ghost);margin-top:3px;}
.watch-school{font-family:'Fira Code',monospace;font-size:9px;color:var(--ink-ghost);padding:2px 8px;background:var(--raised);border-radius:8px;border:1px solid var(--border);flex-shrink:0;white-space:nowrap;}

/* Insight box */
.insight{display:flex;gap:10px;align-items:flex-start;background:linear-gradient(135deg,var(--cobalt-dim),var(--stone-50));border:1px solid rgba(26,58,122,0.12);border-radius:8px;padding:11px 13px;margin-top:14px;}
.insight-icon{font-size:13px;flex-shrink:0;margin-top:1px;}
.insight-text{font-size:11px;color:var(--ink-mid);line-height:1.6;}
.insight-text strong{color:var(--cobalt);font-weight:600;}

/* Metric rows */
.mrow{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);}
.mrow:last-child{border-bottom:none;}
.mrow-name{font-size:11px;color:var(--ink-mid);}
.mrow-right{display:flex;align-items:center;gap:10px;}
.mrow-val{font-family:'Fraunces',serif;font-size:18px;font-weight:400;color:var(--ink);}
.mrow-delta{font-family:'Fira Code',monospace;font-size:9px;}

/* Animations */
@keyframes slideUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
@keyframes drawLine{from{stroke-dashoffset:500;}to{stroke-dashoffset:0;}}
.hero-cell{animation:slideUp 0.4s ease both;}
.hero-cell:nth-child(1){animation-delay:0.04s;}
.hero-cell:nth-child(2){animation-delay:0.08s;}
.hero-cell:nth-child(3){animation-delay:0.12s;}
.hero-cell:nth-child(4){animation-delay:0.16s;}
.hero-cell:nth-child(5){animation-delay:0.20s;}
.card,.school-table-wrap{animation:slideUp 0.4s ease 0.15s both;}
.aline{stroke-dasharray:500;animation:drawLine 1.8s ease 0.3s both;}

/* Tooltip */
.tip-box{position:fixed;background:var(--ink);color:#fff;padding:8px 12px;border-radius:8px;font-size:11px;font-family:'Fira Code',monospace;pointer-events:none;z-index:999;opacity:0;transition:opacity .15s;max-width:220px;line-height:1.5;}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--stone-300);border-radius:3px;}

@media(max-width:1100px){.grid-3{grid-template-columns:1fr 1fr;}.region-hero{grid-template-columns:repeat(3,1fr);}}
@media(max-width:800px){.content{padding:16px 18px;}.region-hero{grid-template-columns:1fr 1fr;}.grid-2-1,.grid-2{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="tip-box" id="globalTip"></div>

<header class="header">
  <div class="header-brand">
    <div class="header-logo">‚óà</div>
    <div class="header-name">Regional Intelligence <span>¬∑ EU Portfolio</span></div>
  </div>
  <nav class="header-nav">
    <a href="Leaders-dahsboard.html" class="nav-tab active">Portfolio Overview</a>
    <a href="Leaders-datastory.html" class="nav-tab">Portfolio Briefing</a>
    <a href="Leaders-email-alert.html" class="nav-tab">Alert Email <span class="nav-badge" id="alertBadge">0</span></a>
    <a href="index.html" class="nav-tab">Principal View ‚Üó</a>
    <a href="principal-datastory.html" class="nav-tab">Principal Briefing</a>
  </nav>
  <div class="header-right">
    <div class="hdr-chip on" id="metaFY">FY 2026</div>
    <div class="hdr-chip on" id="metaEY">EY 2027</div>
    <div class="hdr-chip off"><select id="schoolFilter"><option value="">All Schools</option></select></div>
  </div>
</header>

<div class="content">
  <div class="slabel" id="regionLabel">EU Region ¬∑ At a Glance</div>

  <!-- HERO STRIP ‚Äî populated by JS -->
  <div class="region-hero" id="heroStrip"></div>

  <!-- SCHOOL LEAGUE TABLE -->
  <div class="slabel">School Performance Comparison</div>
  <div class="school-table-wrap">
    <div class="school-table-head">
      <div>
        <div class="sth-title">All Schools ¬∑ EU Region</div>
        <div class="sth-sub" id="tableSubLabel"></div>
      </div>
      <div class="sort-btns" id="sortBtns"></div>
    </div>
    <table class="school-table">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- PORTFOLIO DIAGNOSTICS -->
  <div class="slabel">Portfolio Diagnostics</div>
  <div class="grid-2-1">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">School √ó Metric Heatmap</div>
          <div class="card-sub">RAG status across 8 key metrics per school</div>
        </div>
        <span class="badge badge-b">Portfolio View</span>
      </div>
      <div class="card-body">
        <canvas id="heatmapCanvas" height="200" style="width:100%;height:auto;"></canvas>
        <div class="insight"><div class="insight-icon">üîç</div><div class="insight-text" id="heatmapInsight"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Intervention Watchlist</div>
          <div class="card-sub">Schools requiring leadership action</div>
        </div>
        <span class="badge badge-r" id="watchlistBadge">0 Items</span>
      </div>
      <div id="watchlistBody"></div>
    </div>
  </div>

  <!-- FUNNEL / NPS / CAPACITY -->
  <div class="grid-3">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Enrolment CVR by School</div>
          <div class="card-sub" id="cvrSubLabel"></div>
        </div>
      </div>
      <div class="card-body">
        <canvas id="funnelChart" height="220" style="width:100%;height:auto;"></canvas>
        <div class="insight"><div class="insight-icon">üí°</div><div class="insight-text" id="cvrInsight"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">NPS Movement YoY</div>
          <div class="card-sub">School-level shift in parent sentiment</div>
        </div>
      </div>
      <div class="card-body">
        <svg id="slopeChart" viewBox="0 0 260 220" style="width:100%;height:220px;overflow:visible;"></svg>
        <div class="insight"><div class="insight-icon">üí°</div><div class="insight-text" id="npsInsight"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Capacity vs Enrolment Growth</div>
          <div class="card-sub">Bubble size = total FTE</div>
        </div>
      </div>
      <div class="card-body">
        <svg id="bubbleChart" viewBox="0 0 260 220" style="width:100%;height:220px;overflow:visible;"></svg>
        <div class="insight"><div class="insight-icon">üí°</div><div class="insight-text" id="capacityInsight"></div></div>
      </div>
    </div>
  </div>

  <!-- ACADEMIC + FINANCIAL -->
  <div class="slabel">Academic ¬∑ Financial Portfolio</div>
  <div class="grid-2" style="margin-bottom:28px;">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Academic Outcomes ‚Äî Regional View</div>
          <div class="card-sub">IB, A-Level, iGCSE ‚Äî FY2025 Results</div>
        </div>
        <span class="badge badge-a">A-Level ‚Üì Alert</span>
      </div>
      <div class="card-body">
        <canvas id="academicChart" height="180" style="width:100%;height:auto;"></canvas>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:16px;" id="academicCards"></div>
        <div class="insight"><div class="insight-icon">‚ö†Ô∏è</div><div class="insight-text" id="academicInsight"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Financial Performance</div>
          <div class="card-sub">OneStream ¬∑ FY2026 ¬∑ EU Region</div>
        </div>
        <span class="badge badge-g">On Budget</span>
      </div>
      <div class="card-body">
        <canvas id="finChart" height="180" style="width:100%;height:auto;"></canvas>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px;" id="financialCards"></div>
      </div>
    </div>
  </div>
</div>

<!-- Load data layer first -->
<script src="portfolio-data.js"></script>
<script>
(function () {
  const P = window.PORTFOLIO;
  const S = P.SCHOOLS;
  const R = P.REGIONAL;
  const INS = P.generateInsights();
  const ALERTS = P.getAlerts();

  // ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tip = document.getElementById('globalTip');
  function showTip(e, html) {
    tip.innerHTML = html;
    tip.style.opacity = '1';
    moveTip(e);
  }
  function moveTip(e) {
    tip.style.left = (e.clientX + 14) + 'px';
    tip.style.top  = (e.clientY - 10) + 'px';
  }
  function hideTip() { tip.style.opacity = '0'; }
  document.addEventListener('mousemove', moveTip);

  // ‚îÄ‚îÄ META ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('regionLabel').textContent = `EU Region ¬∑ At a Glance ¬∑ ${P.META.source}`;
  document.getElementById('tableSubLabel').textContent = `Salesforce Wk ${P.META.dataWeek} ¬∑ ${P.META.fiscalYear} ¬∑ ${P.META.enrolmentYear}`;
  document.getElementById('metaFY').textContent = P.META.fiscalYear;
  document.getElementById('metaEY').textContent = P.META.enrolmentYear;

  // Alert badge
  document.getElementById('alertBadge').textContent = ALERTS.filter(a => a.severity === 'critical').length;

  // School filter dropdown
  const sf = document.getElementById('schoolFilter');
  S.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sf.appendChild(o); });

  // Sort buttons
  const sortDefs = [
    { key: 'fteVsBudget', label: 'FTE vs Budget' },
    { key: 'nps',         label: 'NPS' },
    { key: 'enrolmentsYoY', label: 'Enrolments' },
    { key: 'velocity',    label: 'Velocity' },
    { key: 'capacity',    label: 'Capacity' },
  ];
  let currentSort = 'fteVsBudget';
  const sortBtns = document.getElementById('sortBtns');
  sortDefs.forEach(d => {
    const btn = document.createElement('div');
    btn.className = 'sort-btn' + (d.key === currentSort ? ' on' : '');
    btn.textContent = d.label;
    btn.onclick = () => {
      currentSort = d.key;
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('on'));
      btn.classList.add('on');
      renderTable();
    };
    sortBtns.appendChild(btn);
  });

  // ‚îÄ‚îÄ HERO STRIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const heroDefs = [
    {
      label: 'Forecast FTE vs Budget',
      value: P.fmt(R.fteVsBudget, 'pct'),
      cls: 'bad', vcls: 'bad', dcls: 'dn',
      delta: `‚Üì ${Math.abs(R.fteDelta).toLocaleString()} students short`,
      sub: `Budget: ${R.fteBudget.toLocaleString()} ¬∑ Forecast: ${R.fteForecast.toLocaleString()}`,
      spark: 'down',
      tooltip: `FTE budget gap: ${Math.abs(R.fteDelta)} students ¬∑ Threshold: ‚àí2% ¬∑ Actual: ${(R.fteVsBudget*100).toFixed(1)}%`,
    },
    {
      label: 'New Enrolments YoY',
      value: P.fmt(R.enrolmentsYoY, 'pct'),
      cls: 'bad', vcls: 'bad', dcls: 'dn',
      delta: `‚Üì ${Math.abs(R.enrolmentDelta)} fewer students`,
      sub: `${R.enrolments} enrolled ¬∑ LY: ${R.enrolmentsPY}`,
      spark: 'down',
      tooltip: `New enrolments: ${R.enrolments} vs ${R.enrolmentsPY} last year ¬∑ ${Math.abs(R.enrolmentDelta)} lost`,
    },
    {
      label: 'Avg Conversion Velocity',
      value: `${R.avgVelocity} d`,
      cls: 'warn', vcls: 'warn', dcls: 'wn',
      delta: `‚ö† Beau Soleil ${S[1].metrics.velocity}d`,
      sub: `Enq ‚Üí Enrolment ¬∑ Best: ${P.getBest('velocity').name} ${P.getBest('velocity').metrics.velocity}d`,
      spark: 'flat',
      tooltip: `Portfolio avg velocity: ${R.avgVelocity}d (PY: ${R.avgVelocityPY}d) ¬∑ Target: ‚â§120d`,
    },
    {
      label: 'Regional NPS',
      value: String(R.nps),
      cls: 'warn', vcls: 'warn', dcls: 'wn',
      delta: `‚ñ≥ Below ${R.npsTarget} target`,
      sub: `PY: ${R.npsPY} ¬∑ Best: ${P.getBest('nps').name} ${P.getBest('nps').metrics.nps}`,
      spark: 'flat',
      tooltip: `NPS: ${R.nps} ¬∑ Target: ${R.npsTarget} ¬∑ YoY: ${R.nps - R.npsPY > 0 ? '+' : ''}${R.nps - R.npsPY}`,
    },
    {
      label: 'Capacity ¬∑ Fee Income',
      value: R.capacity + '%',
      cls: 'good', vcls: 'good', dcls: 'up',
      delta: `‚úì ${P.fmt(R.feeIncome, '$M')} on budget`,
      sub: `EBITDA ${P.fmt(R.ebitda, '$M')} ¬∑ Flowthrough ${R.flowthroughPct}%`,
      spark: 'up',
      tooltip: `Capacity: ${R.capacity}% ¬∑ Fee income: ${P.fmt(R.feeIncome, '$M')} vs budget ${P.fmt(R.feeBudget, '$M')}`,
    },
  ];

  const sparkPaths = {
    down: '0,10 20,12 40,14 60,18 80,20 100,22 120,24',
    up:   '0,24 20,22 40,18 60,16 80,14 100,12 120,10',
    flat: '0,16 20,14 40,12 60,14 80,16 100,14 120,14',
  };
  const sparkColors = { down: 'var(--crimson)', up: 'var(--emerald)', flat: 'var(--amber)' };

  const hero = document.getElementById('heroStrip');
  heroDefs.forEach(h => {
    const cell = document.createElement('div');
    cell.className = `hero-cell ${h.cls}`;
    cell.innerHTML = `
      <div class="hc-label">${h.label}</div>
      <div class="hc-value ${h.vcls}">${h.value}</div>
      <div class="hc-delta ${h.dcls}">${h.delta}</div>
      <div class="hc-sub">${h.sub}</div>
      <div class="hc-spark">
        <svg width="100%" height="28" viewBox="0 0 120 28" preserveAspectRatio="none">
          <polyline class="aline" points="${sparkPaths[h.spark]}" fill="none" stroke="${sparkColors[h.spark]}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.6"/>
          <circle cx="120" cy="${h.spark==='down'?24:h.spark==='up'?10:14}" r="2.5" fill="${sparkColors[h.spark]}" opacity="0.8"/>
        </svg>
      </div>`;
    cell.addEventListener('mouseenter', e => showTip(e, h.tooltip));
    cell.addEventListener('mouseleave', hideTip);
    hero.appendChild(cell);
  });

  // ‚îÄ‚îÄ LEAGUE TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const colDefs = [
    { label: 'School', key: null, align: 'left' },
    { label: 'FTE vs Budget', key: 'fteVsBudget', align: 'right', fmt: v => `<span style="color:${v<-0.025?'var(--crimson)':v<0?'var(--amber)':'var(--emerald)'};font-family:'Fira Code',monospace;font-size:11px;font-weight:600;">${P.fmt(v,'pct')}</span>` },
    { label: 'New Enr. YoY', key: 'enrolmentsYoY', align: 'right', fmt: v => `<span style="color:${v<-0.15?'var(--crimson)':v<-0.05?'var(--amber)':'var(--emerald)'};font-family:'Fira Code',monospace;font-size:11px;">${P.fmt(v,'pct')}</span>` },
    { label: 'Enquiries YoY', key: 'enquiriesYoY', align: 'right', fmt: v => `<span style="color:${v<-0.18?'var(--crimson)':v<-0.05?'var(--amber)':'var(--emerald)'};font-family:'Fira Code',monospace;font-size:11px;">${P.fmt(v,'pct')}</span>` },
    { label: 'CVR (Enq‚ÜíEnr)', key: 'cvr', align: 'left', bar: true },
    { label: 'Velocity', key: 'velocity', align: 'right', fmt: v => `<span style="color:${v>=150?'var(--crimson)':v>=120?'var(--amber)':'var(--emerald)'};font-family:'Fira Code',monospace;font-size:11px;">${v}d ${v>=120?'‚ö†':v<100?'‚úì':''}</span>` },
    { label: 'Capacity', key: 'capacity', align: 'left', bar: true },
    { label: 'NPS', key: 'nps', align: 'right', fmt: v => v===null?'<span style="color:var(--ink-ghost)">‚Äî</span>':`<span style="font-family:'Fraunces',serif;font-size:16px;font-weight:400;color:${v>=35?'var(--emerald)':v>=30?'var(--ink)':'var(--crimson)'};">${v}</span>` },
    { label: 'Status', key: null, align: 'left' },
  ];

  const thead = document.getElementById('tableHead');
  const tr = document.createElement('tr');
  colDefs.forEach(c => {
    const th = document.createElement('th');
    th.className = c.align === 'right' ? 'num' : '';
    th.textContent = c.label;
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  function getStatus(s) {
    const m = s.metrics;
    const redCount = [m.fteVsBudget <= -0.025, m.enrolmentsYoY <= -0.15, m.enquiriesYoY <= -0.18, m.capacity <= 60].filter(Boolean).length;
    if (redCount >= 3) return { text: 'Critical', cls: 'r' };
    if (m.fteVsBudget >= 0 && m.nps >= 35) return { text: 'On Track', cls: 'g' };
    if (redCount >= 1) return { text: m.enrolmentsYoY <= -0.30 ? 'Watch' : 'Monitor', cls: 'a' };
    return { text: 'Watch', cls: 'a' };
  }

  function renderTable() {
    const sorted = [...S].sort((a, b) => {
      const va = a.metrics[currentSort] ?? -Infinity;
      const vb = b.metrics[currentSort] ?? -Infinity;
      return currentSort === 'velocity' ? va - vb : vb - va;
    });

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    sorted.forEach(s => {
      const m = s.metrics;
      const tr = document.createElement('tr');
      const drillLink = s.principalDashboard ? `<a href="${s.principalDashboard}" class="drill-link">‚Üó drill</a>` : '';

      const cells = [
        // School name
        `<td><div class="school-name-cell">
          <div class="school-initial" style="background:${s.colorDim};color:${s.color};">${s.initial}</div>
          <div><div class="school-nm">${s.name}${drillLink}</div><div class="school-loc">${s.country} ¬∑ ${s.segments}</div></div>
        </div></td>`,
        // FTE vs Budget
        `<td class="num">${colDefs[1].fmt(m.fteVsBudget)}</td>`,
        // Enrolments YoY
        `<td class="num">${colDefs[2].fmt(m.enrolmentsYoY)}</td>`,
        // Enquiries YoY
        `<td class="num">${colDefs[3].fmt(m.enquiriesYoY)}</td>`,
        // CVR bar
        `<td><div class="ibar-wrap">
          <div class="ibar-track"><div class="ibar-fill" style="width:${Math.min(m.cvr/12*100,100)}%;background:${m.cvr>=7?'var(--emerald)':m.cvr>=5?'var(--amber)':'var(--crimson)'};opacity:0.75;"></div></div>
          <div class="ibar-val" style="color:${m.cvr>=7?'var(--emerald)':m.cvr>=5?'var(--amber)':'var(--crimson)'};">${m.cvrDelta>0?'+':''}${m.cvrDelta.toFixed(1)}%</div>
        </div></td>`,
        // Velocity
        `<td class="num">${colDefs[5].fmt(m.velocity)}</td>`,
        // Capacity bar
        `<td><div class="ibar-wrap">
          <div class="ibar-track"><div class="ibar-fill" style="width:${Math.min(m.capacity,100)}%;background:${m.capacity>=85?'var(--emerald)':m.capacity>=70?'var(--amber)':'var(--crimson)'};opacity:0.7;"></div></div>
          <div class="ibar-val" style="color:${m.capacity>=85?'var(--emerald)':m.capacity>=70?'var(--amber)':'var(--crimson)'};">${m.capacity}%</div>
        </div></td>`,
        // NPS
        `<td class="num">${colDefs[7].fmt(m.nps)}</td>`,
        // Status
        `<td><span class="rag ${getStatus(s).cls}">${getStatus(s).text}</span></td>`,
      ];
      tr.innerHTML = cells.join('');
      tr.addEventListener('mouseenter', e => showTip(e, `${s.name} ¬∑ ${s.location}<br>CVR: ${m.cvr}% ¬∑ Velocity: ${m.velocity}d ¬∑ Capacity: ${m.capacity}%<br>Enrolments: ${m.enrolments} (PY: ${m.enrolmentsPY})`));
      tr.addEventListener('mouseleave', hideTip);
      tbody.appendChild(tr);
    });

    // Total row
    const tot = document.createElement('tr');
    tot.className = 'total-row';
    tot.innerHTML = `
      <td><div style="font-size:11px;color:var(--ink-soft);font-family:'Fira Code',monospace;letter-spacing:0.06em;">EU TOTAL</div></td>
      <td class="num" style="color:var(--crimson);font-family:'Fira Code',monospace;font-size:11px;font-weight:700;">${P.fmt(R.fteVsBudget,'pct')}</td>
      <td class="num" style="color:var(--crimson);font-family:'Fira Code',monospace;font-size:11px;">${P.fmt(R.enrolmentsYoY,'pct')}</td>
      <td class="num" style="color:var(--crimson);font-family:'Fira Code',monospace;font-size:11px;">${P.fmt(R.enquiriesYoY,'pct')}</td>
      <td><div class="ibar-wrap"><div class="ibar-track"><div class="ibar-fill" style="width:48%;background:var(--ink-ghost);"></div></div><div class="ibar-val" style="color:var(--ink-soft);">flat</div></div></td>
      <td class="num" style="color:var(--amber);font-family:'Fira Code',monospace;font-size:11px;">${R.avgVelocity}d</td>
      <td><div class="ibar-wrap"><div class="ibar-track"><div class="ibar-fill" style="width:${R.capacity}%;background:var(--emerald);opacity:0.7;"></div></div><div class="ibar-val" style="color:var(--emerald);">${R.capacity}%</div></div></td>
      <td class="num" style="font-family:'Fraunces',serif;font-size:16px;font-weight:500;color:var(--amber);">${R.nps}</td>
      <td><span class="rag a">Mixed</span></td>`;
    tbody.appendChild(tot);
  }
  renderTable();

  // ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const canvas = document.getElementById('heatmapCanvas');
    const hd = P.getHeatmapData();
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.parentElement.offsetWidth - 40 || 520;
    const H = 200;
    canvas.width = W * dpr; canvas.height = H * dpr;
    canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);

    const leftPad = 84, topPad = 32, cellW = (W - leftPad - 8) / hd.metrics.length;
    const cellH = (H - topPad - 6) / hd.rows.length;
    const colors = { r: '#fdf0ee', a: '#fdf5e6', g: '#edf7f3' };
    const tColors = { r: '#c0392b', a: '#b8680a', g: '#1a6b50' };

    // Headers
    ctx.font = '500 8px Fira Code, monospace';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#b0a898';
    hd.metrics.forEach((m, j) => ctx.fillText(m.label, leftPad + j * cellW + cellW / 2, 20));

    // Rows
    hd.rows.forEach((row, i) => {
      ctx.font = '500 10px Bricolage Grotesque, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillStyle = '#3d3730';
      ctx.fillText(row.school.name, leftPad - 8, topPad + i * cellH + cellH / 2 + 4);

      row.cells.forEach((cell, j) => {
        const x = leftPad + j * cellW + 2, y = topPad + i * cellH + 2;
        const cw = cellW - 4, ch = cellH - 4;
        ctx.fillStyle = colors[cell.rag];
        ctx.beginPath(); ctx.roundRect(x, y, cw, ch, 4); ctx.fill();
        ctx.font = '500 9px Fira Code, monospace';
        ctx.textAlign = 'center';
        ctx.fillStyle = tColors[cell.rag];
        ctx.fillText(cell.display, x + cw / 2, y + ch / 2 + 3.5);
      });
    });

    // Insight
    document.getElementById('heatmapInsight').innerHTML =
      `<strong>${P.getWorst('enrolmentsYoY').name} needs immediate escalation</strong> ‚Äî red across ${
        P.getHeatmapData().rows.find(r => r.school.id === P.getWorst('enrolmentsYoY').id)
          .cells.filter(c => c.rag === 'r').length
      } of 8 metrics. ${INS.beauSoleilOpportunity}`;
  })();

  // ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const watchIcons = { critical: 'üìâ', warning: '‚ö†Ô∏è' };
  const watchAlerts = ALERTS.slice(0, 5);
  document.getElementById('watchlistBadge').textContent = watchAlerts.length + ' Items';
  document.getElementById('watchlistBadge').className = watchAlerts.filter(a => a.severity === 'critical').length > 2 ? 'badge badge-r' : 'badge badge-a';

  const wBody = document.getElementById('watchlistBody');
  watchAlerts.forEach(a => {
    const row = document.createElement('div');
    row.className = 'watchlist-row';
    row.innerHTML = `
      <div class="watch-sev ${a.severity}"></div>
      <div class="watch-icon ${a.severity === 'critical' ? 'wi-red' : 'wi-amber'}">${watchIcons[a.severity] || '‚ö†Ô∏è'}</div>
      <div class="watch-body">
        <div class="watch-title">${a.metric} ‚Äî ${a.value}</div>
        <div class="watch-desc">${a.desc}</div>
        <div class="watch-metric">Threshold: ${a.threshold}</div>
      </div>
      <div class="watch-school">${a.school}</div>`;
    row.addEventListener('mouseenter', e => showTip(e, `${a.metric}<br>${a.school} ¬∑ ${a.value}<br>Threshold: ${a.threshold}`));
    row.addEventListener('mouseleave', hideTip);
    wBody.appendChild(row);
  });

  // ‚îÄ‚îÄ FUNNEL / CVR BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('cvrSubLabel').textContent = `${P.META.enrolmentYear} ¬∑ Enquiry ‚Üí Enrolment CVR`;
  (function () {
    const canvas = document.getElementById('funnelChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.parentElement.offsetWidth - 40 || 300;
    const H = 220;
    canvas.width = W * dpr; canvas.height = H * dpr;
    canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);

    const maxCVR = Math.max(...S.map(s => s.metrics.cvr)) * 1.15;
    const sorted = [...S].sort((a, b) => a.metrics.cvr - b.metrics.cvr);
    const barH = 24, gap = 8, padL = 76, padT = 8, padR = 16;
    const chartW = W - padL - padR;

    sorted.forEach((s, i) => {
      const cvr = s.metrics.cvr;
      const y = padT + i * (barH + gap);
      const bw = (cvr / maxCVR) * chartW;

      ctx.fillStyle = '#f5f4f0';
      ctx.beginPath(); ctx.roundRect(padL, y, chartW, barH, 4); ctx.fill();
      ctx.fillStyle = s.color; ctx.globalAlpha = 0.85;
      ctx.beginPath(); ctx.roundRect(padL, y, bw, barH, 4); ctx.fill();
      ctx.globalAlpha = 1;

      ctx.font = '500 10px Bricolage Grotesque, sans-serif';
      ctx.textAlign = 'right'; ctx.fillStyle = '#3d3730';
      ctx.fillText(s.name, padL - 6, y + barH / 2 + 3.5);

      ctx.font = '500 10px Fira Code, monospace';
      ctx.textAlign = 'left';
      if (bw > 28) {
        ctx.fillStyle = '#fff';
        ctx.fillText(cvr + '%', padL + 6, y + barH / 2 + 3.5);
      } else {
        ctx.fillStyle = s.color;
        ctx.fillText(cvr + '%', padL + bw + 5, y + barH / 2 + 3.5);
      }
    });
    ctx.font = '400 8.5px Fira Code, monospace';
    ctx.textAlign = 'center'; ctx.fillStyle = '#b0a898';
    ctx.fillText('Enquiry ‚Üí Enrolment CVR %', padL + chartW / 2, H - 4);

    document.getElementById('cvrInsight').innerHTML = INS.cvrGap + ' ' + INS.cvrAction;
  })();

  // ‚îÄ‚îÄ NPS SLOPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const svg = document.getElementById('slopeChart');
    const W = 260, H = 220, padL = 62, padR = 72, padT = 20, padB = 30;
    const x1 = padL, x2 = W - padR;
    const allNPS = S.flatMap(s => [s.metrics.npsPrev, s.metrics.nps]).filter(v => v !== null);
    const minV = Math.min(...allNPS) - 3;
    const maxV = Math.max(...allNPS) + 3;
    const scY = v => padT + ((maxV - v) / (maxV - minV)) * (H - padT - padB);

    svg.innerHTML = `
      <text x="${x1}" y="${H-6}" font-family="Fira Code,monospace" font-size="9" fill="#b0a898" text-anchor="middle">Last Year</text>
      <text x="${x2}" y="${H-6}" font-family="Fira Code,monospace" font-size="9" fill="#b0a898" text-anchor="middle">This Year</text>
      <line x1="${x1}" y1="${padT}" x2="${x1}" y2="${H-padB}" stroke="#e0dbd2" stroke-width="1"/>
      <line x1="${x2}" y1="${padT}" x2="${x2}" y2="${H-padB}" stroke="#e0dbd2" stroke-width="1"/>`;

    // Target line
    const tY = scY(P.THRESHOLDS.nps.target);
    svg.innerHTML += `<line x1="${x1-8}" y1="${tY}" x2="${x2+8}" y2="${tY}" stroke="#1a6b50" stroke-width="1" stroke-dasharray="4,3" opacity="0.45"/>
      <text x="${x2+10}" y="${tY+3}" font-family="Fira Code,monospace" font-size="8" fill="#1a6b50" opacity="0.7">Target</text>`;

    S.forEach(s => {
      const prev = s.metrics.npsPrev;
      const curr = s.metrics.nps;
      if (curr === null) return;
      const y1 = scY(prev), y2 = scY(curr);
      const dir = curr >= prev ? '‚Üë' : '‚Üì';
      svg.innerHTML += `
        <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${s.color}" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
        <circle cx="${x1}" cy="${y1}" r="5" fill="${s.color}" opacity="0.45"/>
        <circle cx="${x2}" cy="${y2}" r="5" fill="${s.color}"/>
        <text x="${x1-7}" y="${y1+3.5}" font-family="Fira Code,monospace" font-size="9" fill="${s.color}" text-anchor="end" font-weight="500">${prev}</text>
        <text x="${x2+7}" y="${y2+3.5}" font-family="Fira Code,monospace" font-size="9" fill="${s.color}" font-weight="600">${curr}</text>
        <text x="${x2+20}" y="${y2+3.5}" font-family="Fira Code,monospace" font-size="8" fill="${s.color}">${dir}</text>
        <text x="${(x1+x2)/2}" y="${(y1+y2)/2-6}" font-family="Bricolage Grotesque,sans-serif" font-size="8.5" fill="${s.color}" text-anchor="middle" opacity="0.9">${s.name}</text>`;
    });
    document.getElementById('npsInsight').innerHTML = INS.npsLeader;
  })();

  // ‚îÄ‚îÄ CAPACITY BUBBLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const svg = document.getElementById('bubbleChart');
    const W = 260, H = 220, padL = 30, padR = 22, padT = 15, padB = 28;
    const cW = W - padL - padR, cH = H - padT - padB;

    const xs = S.map(s => s.metrics.enrolmentsYoY * 100);
    const ys = S.map(s => s.metrics.capacity);
    const xMin = Math.min(...xs) - 8, xMax = Math.max(...xs) + 8;
    const yMin = Math.min(...ys) - 10, yMax = Math.max(...ys) + 10;

    const sx = v => padL + ((v - xMin) / (xMax - xMin)) * cW;
    const sy = v => padT + cH - ((v - yMin) / (yMax - yMin)) * cH;
    const sr = fte => Math.sqrt(fte / 350) * 11;

    // Grid lines
    [60, 80, 100].forEach(v => {
      const y = sy(v);
      svg.innerHTML += `<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="#e0dbd2" stroke-width="1" stroke-dasharray="3,4"/>
        <text x="${padL-4}" y="${y+3}" font-family="Fira Code,monospace" font-size="8" fill="#b0a898" text-anchor="end">${v}%</text>`;
    });
    [-60,-40,-20,0,20].forEach(v => {
      const x = sx(v);
      if (x < padL || x > W - padR) return;
      svg.innerHTML += `<line x1="${x}" y1="${padT}" x2="${x}" y2="${H-padB}" stroke="#e0dbd2" stroke-width="1" stroke-dasharray="3,4"/>
        <text x="${x}" y="${H-padB+13}" font-family="Fira Code,monospace" font-size="8" fill="#b0a898" text-anchor="middle">${v}%</text>`;
    });
    const x0 = sx(0);
    svg.innerHTML += `<line x1="${x0}" y1="${padT}" x2="${x0}" y2="${H-padB}" stroke="#d4cfc6" stroke-width="1.5"/>`;
    svg.innerHTML += `<text x="${W/2}" y="${H}" font-family="Fira Code,monospace" font-size="8.5" fill="#b0a898" text-anchor="middle">New Enrolment Growth %</text>`;

    S.forEach(s => {
      const bx = sx(s.metrics.enrolmentsYoY * 100);
      const by = sy(s.metrics.capacity);
      const r = sr(s.metrics.fte);
      svg.innerHTML += `
        <circle cx="${bx}" cy="${by}" r="${r}" fill="${s.color}" opacity="0.12"/>
        <circle cx="${bx}" cy="${by}" r="${r}" fill="none" stroke="${s.color}" stroke-width="2" opacity="0.75"/>
        <text x="${bx}" y="${by+3.5}" font-family="Bricolage Grotesque,sans-serif" font-size="9" fill="${s.color}" text-anchor="middle" font-weight="600">${s.name.split(' ')[0]}</text>`;
    });
    document.getElementById('capacityInsight').innerHTML = INS.beauSoleilOpportunity + ' ' + INS.capacityRisk;
  })();

  // ‚îÄ‚îÄ ACADEMIC BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const canvas = document.getElementById('academicChart');
    const A = P.ACADEMIC;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.parentElement.offsetWidth - 40 || 460, H = 180;
    canvas.width = W * dpr; canvas.height = H * dpr;
    canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);

    const metrics = [
      { label: 'A-Level A*‚ÄìA', curr: A.aLevel.current, prev: A.aLevel.prev, target: A.aLevel.target, color: '#c0392b' },
      { label: 'iGCSE A*‚ÄìA',  curr: A.igcse.current,  prev: A.igcse.prev,  target: A.igcse.target,  color: '#1a6b50' },
      { label: 'IB Diploma',  curr: A.ib.current * 1.5, prev: A.ib.prev * 1.5, target: A.ib.target * 1.5, color: '#1a3a7a', scale: 1/1.5 },
    ];
    const maxV = 80, padL = 112, padT = 18, padB = 22, padR = 18;
    const cW = W - padL - padR;
    const groupH = 26, groupGap = 18, barGap = 3, barH = (groupH - barGap) / 2;

    metrics.forEach((m, i) => {
      const y0 = padT + i * (groupH + groupGap);
      ctx.font = '500 10px Bricolage Grotesque, sans-serif';
      ctx.textAlign = 'right'; ctx.fillStyle = '#3d3730';
      ctx.fillText(m.label, padL - 8, y0 + groupH / 2 + 3);

      const bwPrev = (m.prev / maxV) * cW;
      ctx.fillStyle = '#e8e5df';
      ctx.beginPath(); ctx.roundRect(padL, y0, bwPrev, barH, 3); ctx.fill();
      const prevLabel = m.scale ? (m.prev * m.scale).toFixed(1) : m.prev + '%';
      ctx.font = '400 9px Fira Code, monospace'; ctx.fillStyle = '#b0a898'; ctx.textAlign = 'left';
      ctx.fillText('LY: ' + prevLabel, padL + bwPrev + 5, y0 + barH / 2 + 3);

      const bwCurr = (m.curr / maxV) * cW;
      ctx.fillStyle = m.color; ctx.globalAlpha = 0.85;
      ctx.beginPath(); ctx.roundRect(padL, y0 + barH + barGap, bwCurr, barH, 3); ctx.fill();
      ctx.globalAlpha = 1;
      const currLabel = m.scale ? (m.curr * m.scale).toFixed(1) : m.curr + '%';
      ctx.font = '500 9px Fira Code, monospace'; ctx.fillStyle = m.color; ctx.textAlign = 'left';
      ctx.fillText(currLabel, padL + bwCurr + 5, y0 + barH + barGap + barH / 2 + 3);

      // Target marker
      const bwTgt = (m.target / maxV) * cW;
      ctx.strokeStyle = m.color; ctx.lineWidth = 1.5; ctx.setLineDash([3,3]);
      ctx.beginPath(); ctx.moveTo(padL + bwTgt, y0); ctx.lineTo(padL + bwTgt, y0 + groupH); ctx.stroke();
      ctx.setLineDash([]);
    });

    // Academic stat cards
    const aCards = document.getElementById('academicCards');
    const cardDefs = [
      { label: 'IB Diploma', val: A.ib.current, prev: A.ib.prev, unit: '', color: 'var(--emerald)', dir: '+' },
      { label: 'A-Level A*‚ÄìA', val: A.aLevel.current + '%', prev: A.aLevel.prev + '%', unit: '', color: 'var(--crimson)', dir: '‚Üì' },
      { label: 'iGCSE A*‚ÄìA', val: A.igcse.current + '%', prev: A.igcse.prev + '%', unit: '', color: 'var(--amber)', dir: '‚Üì' },
    ];
    aCards.innerHTML = cardDefs.map(c => `
      <div style="background:var(--raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-family:'Fira Code',monospace;font-size:8px;color:var(--ink-ghost);margin-bottom:4px;letter-spacing:0.1em;text-transform:uppercase;">${c.label}</div>
        <div style="font-family:'Fraunces',serif;font-size:26px;font-weight:400;color:${c.color};">${c.val}</div>
        <div style="font-family:'Fira Code',monospace;font-size:9px;color:${c.color};margin-top:3px;">${c.dir} vs ${c.prev} PY</div>
      </div>`).join('');

    document.getElementById('academicInsight').innerHTML = INS.aLevelContext;
  })();

  // ‚îÄ‚îÄ FINANCIAL TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const canvas = document.getElementById('finChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.parentElement.offsetWidth - 40 || 460, H = 180;
    canvas.width = W * dpr; canvas.height = H * dpr;
    canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);

    const FT = P.FINANCIAL_TREND;
    const maxV = Math.max(...FT.map(d => d.feeIncome)) * 1.1;
    const padL = 36, padT = 10, padB = 28, padR = 18;
    const cW = W - padL - padR, cH = H - padT - padB;
    const xPos = i => padL + (i / (FT.length - 1)) * cW;
    const yPos = v => padT + cH - (v / maxV) * cH;

    [0, 25, 50, 75].forEach(v => {
      const y = yPos(v);
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y);
      ctx.strokeStyle = '#e8e5df'; ctx.lineWidth = 1; ctx.stroke();
      ctx.font = '400 8px Fira Code, monospace'; ctx.fillStyle = '#b0a898'; ctx.textAlign = 'right';
      ctx.fillText('$' + v + 'M', padL - 4, y + 3);
    });

    // Fee income area fill
    ctx.beginPath();
    FT.forEach((d, i) => { i===0 ? ctx.moveTo(xPos(i), yPos(d.feeIncome)) : ctx.lineTo(xPos(i), yPos(d.feeIncome)); });
    ctx.lineTo(xPos(FT.length-1), padT + cH);
    ctx.lineTo(xPos(0), padT + cH);
    ctx.closePath();
    ctx.fillStyle = 'rgba(26,107,80,0.07)'; ctx.fill();

    // Fee income line
    ctx.beginPath();
    FT.forEach((d, i) => { i===0 ? ctx.moveTo(xPos(i), yPos(d.feeIncome)) : ctx.lineTo(xPos(i), yPos(d.feeIncome)); });
    ctx.strokeStyle = '#1a6b50'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.stroke();

    // EBITDA line
    ctx.beginPath();
    FT.forEach((d, i) => { i===0 ? ctx.moveTo(xPos(i), yPos(d.ebitda)) : ctx.lineTo(xPos(i), yPos(d.ebitda)); });
    ctx.strokeStyle = '#1a3a7a'; ctx.lineWidth = 2; ctx.setLineDash([5, 3]); ctx.stroke();
    ctx.setLineDash([]);

    FT.forEach((d, i) => {
      ctx.beginPath(); ctx.arc(xPos(i), yPos(d.feeIncome), 4, 0, Math.PI*2);
      ctx.fillStyle = '#1a6b50'; ctx.fill();
      ctx.font = '500 9px Fira Code, monospace'; ctx.fillStyle = '#1a6b50'; ctx.textAlign = 'center';
      ctx.fillText('$' + d.feeIncome + 'M', xPos(i), yPos(d.feeIncome) - 8);
      ctx.font = '400 9px Fira Code, monospace'; ctx.fillStyle = '#b0a898'; ctx.textAlign = 'center';
      ctx.fillText(d.year, xPos(i), H - 6);
    });

    // Financial stat cards
    const finCards = document.getElementById('financialCards');
    const fcDefs = [
      { label: 'Fee Income', val: P.fmt(R.feeIncome,'$M'), note: '‚úì On budget', color: 'var(--emerald)' },
      { label: 'EBITDA',     val: P.fmt(R.ebitda,'$M'),    note: '‚úì On budget', color: 'var(--emerald)' },
      { label: 'Flowthrough', val: R.flowthroughPct + '%',  note: `‚Üì ‚àí${(R.flowthroughPctPY-R.flowthroughPct).toFixed(1)}pp vs PY`, color: 'var(--crimson)' },
      { label: 'Market Share Growth', val: '+' + (R.marketShareGrowth*100).toFixed(2) + '%', note: 'vs Core Market', color: 'var(--amber)' },
    ];
    finCards.innerHTML = fcDefs.map(c => `
      <div style="background:var(--raised);border:1px solid var(--border);border-radius:8px;padding:12px;">
        <div style="font-family:'Fira Code',monospace;font-size:8px;color:var(--ink-ghost);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.1em;">${c.label}</div>
        <div style="font-family:'Fraunces',serif;font-size:24px;font-weight:400;color:${c.color};">${c.val}</div>
        <div style="font-family:'Fira Code',monospace;font-size:9px;color:${c.color};margin-top:3px;">${c.note}</div>
      </div>`).join('');
  })();

})();
</script>
</body>
</html>
